# VPD {.unnumbered}

```{r setup}
#| include: false
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(tidyverse)
library(terra)
library(sf)
library(leaflet)
theme_set(bayesplot::theme_default())
knitr::opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
```

According to @dasilva2024, we cannot use ERA5 Land reanalysis incapable of representing soil-plant-atmosphere interaction processes in mesoscale interannual scale. Available ground data for Brazil: @xavier2022.

...

## Method

### Forest change

We used the Tropical Moist Forest (TMF) product from the European Joint Research Centre (JRC) to asses forest surface evolution between 2001 and 2020 at 30-m and yearly resolutions. We focused on pixels categorized as undisturbed forest in 2001 and assessed if they were (1) undisturbed, (2) degraded or (3) deforested in 2020. We aggregated the resulting map to 0.01-degree.

```{r tmfdata}
#| include: false
area <- st_read("data/guaviare/guaviare.shp", quiet=T)
temp_r <- rast("results/data/modis_guaviare.nc")
tmf_2001 <- rast("data/JRC_TMF_AnnualChange_v1_SAM_ID47_N10_W80/forobs/products/tmf_v1/AnnualChange/JRC_TMF_AnnualChange_v1_2001_SAM_ID47_N10_W80.tif") %>% crop(area)
msk <- ifel(tmf_2001 != 1, NA, 1)
tmf_2020 <- rast("data/JRC_TMF_AnnualChange_v1_SAM_ID47_N10_W80/forobs/products/tmf_v1/AnnualChange/JRC_TMF_AnnualChange_v1_2020_SAM_ID47_N10_W80.tif") %>% crop(area) %>% mask(msk) %>% as.factor() %>% resample(temp_r)
tmf_2020 <- as.factor(ifel(tmf_2020 %in% 1:3, tmf_2020, NA))
```

```{r tmfplot}
ggplot() +
  tidyterra::geom_spatraster(data = tmf_2020) +
  theme_bw() +
  scale_fill_viridis_d("type") +
  geom_sf(data = area, fill = NA, linewidth = 2) +
  ggtitle("Guiavare forest change", 
          "2020 versus 2001 from JRC TMF")
```

### VPD

...

```{r vpdplot}
area <- st_read("data/guaviare/guaviare.shp", quiet=T)
temp_r <- rast("results/data/era_vpd_guaviare.nc")
ggplot() +
  tidyterra::geom_spatraster(data = temp_r) +
  theme_bw() +
  scale_fill_viridis_c(expression(delta~VPD)) +
  geom_sf(data = area, fill = NA, linewidth = 2) +
  ggtitle("Guiavare January mean VPD variation", 
          "2015-2020 versus 2001-2006")
```

```{r vpddata}
data <- as.data.frame(temp_r, xy = T) %>% 
  left_join(as.data.frame(tmf_2020, xy = T)) %>% 
  na.omit() %>% 
  mutate(type = recode(as.character(Dec2020),
                       "1" = "Undisturbed",
                       "2" = "Degraded",
                       "3" = "Deforested"))
```

### Analysis

For each variable we first realised an analysis of variance of temperature variation against forest change types associated to a Tukey honest significant difference test. To account for spatial autocorrelation, we further realised a linear regression with spatial random effect using a matern covariance and inferred with maximum likelihood on a subset of a thousand pixels. We tested for autocorrelation in residuals of both models Moran's coefficients for 20 distance classes.

## Results

### Analysis of variance (ANOVA)

...

```{r anovaplot}
data %>% 
  ggplot(aes(type, vpd, fill = type)) +
  geom_boxplot() +
  theme_bw() +
  ggpubr::stat_anova_test() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        axis.title = element_blank(),
        legend.position = "bottom") +
  scale_fill_discrete("") +
  ggtitle("Guiavare January VPD variation per forest change")
```

```{r tukey}
TukeyHSD(aov(vpd ~ type, data))$type %>% 
                           as.data.frame() %>% 
                           rownames_to_column("comp") %>% 
  ggplot(aes(comp, diff, col = `p adj` <= 0.05)) +
  geom_point() +
  geom_segment(aes(xend = comp, y = lwr, yend = upr)) +
  theme_bw() +
  coord_flip() +
  geom_vline(xintercept = 0) +
  theme(axis.title = element_blank(), legend.position = "bottom") +
  ggtitle("Tukey honest significant difference tests")
```

```{r anovacor}
data$res_tas <- residuals(aov(vpd ~ type, data))
data2 <- sample_n(data, 1000)
cor <- pgirmess::correlog(data.frame(data2$x, data2$y), data2$res_tas,
                   method = "Moran", nbclass = 20) %>% 
    as.data.frame()
cor %>% 
  ggplot(aes(x = dist.class*100, y = coef)) + 
  geom_point(aes(alpha = p.value < 0.01)) + geom_line() +
  geom_hline(yintercept = 0) +
  theme_bw() +
  xlab("Distance (km)") + ylab("Moran\'s I") +
  ggtitle("ANOVA residuals spatial autocorrelation")
```

### Linear regression with spatial random effect (LRSRE)

<!--# https://hughst.github.io/week-6/ -->

...

```{r spammfit}
#| include: false
#| eval: false
m <- spaMM::fitme(vpd ~ type + Matern(1|y+x), data2)
tab <- summary(m)$beta_table
save(m, tab, file = "save/vpd.Rdata")
```

```{r spammplot}
load("save/vpd.Rdata")
as.data.frame(tab) %>% 
  rename(estimate = "Estimate", se = "Cond. SE", t = "t-value") %>% 
  mutate(lower = estimate - 1.96*se, upper = estimate + 1.96*se) %>% 
  rownames_to_column("type") %>% 
  mutate(type  = c("Deforested", "Degraded", "Undisturbed")) %>% 
  ggplot(aes(type, estimate)) +
  geom_point() +
  geom_segment(aes(xend = type, y = lower, yend = upper)) +
  theme_bw() +
  coord_flip() +
  geom_vline(xintercept = 0) +
  theme(axis.title = element_blank()) +
  ggtitle("LRSRE results")
```

```{r spammcor}
cor <- pgirmess::correlog(coords = data2[,c("x", "y")],
                            z = residuals(m),
                            method="Moran", nbclass=20) %>% 
    as.data.frame()
cor %>% 
  ggplot(aes(x = dist.class*100, y = coef)) + 
  geom_point(aes(alpha = p.value < 0.01)) + geom_line() +
  geom_hline(yintercept = 0) +
  theme_bw() +
  xlab("Distance (km)") + ylab("Moran\'s I") +
  ggtitle("LRSRE residuals spatial autocorrelation")
```
