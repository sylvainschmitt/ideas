# MODIS LST {.unnumbered}

```{r setup}
#| include: false
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(tidyverse)
library(terra)
library(sf)
library(leaflet)
theme_set(bayesplot::theme_default())
knitr::opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
```

```{r data}
#| include: false
capricho <- st_read("data/capricho/capricho.shp")
chirps_r <- rast("results/data/modis_capricho.nc")
chirps <- as.data.frame(chirps_r, xy = T) %>% 
  gather(time_num, precipitation, -x, -y) %>% 
  separate(time_num, c("X1", "X2", "X3", "time_num"), convert = T) %>% 
  select(-X1, -X2, -X3) %>% 
  mutate(time = time(chirps_r)[time_num]) %>% 
  select(-time_num) %>% 
  na.omit()
```

```{r}
chirps %>% 
  mutate(month = month(time)) %>% 
  ggplot(aes(month, precipitation)) +
  annotate("rect", xmin = 0.5, xmax = 2.5, fill  = "#fff4e0",
           ymin = -Inf, ymax = Inf, alpha = 0.5) +
  annotate("rect", xmin = 11.5, xmax = 12.5, fill  = "#fff4e0",
           ymin = -Inf, ymax = Inf, alpha = 0.5) +
  geom_boxplot(aes(group = as.factor(month))) +
  geom_smooth() +
  theme_bw() +
  xlab("") + ylab("Temperature (째C)") +
  scale_x_continuous(breaks = 1:12,
                   labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D")) +
  ggtitle("Capricho seasonality")
```

```{r}
chirps %>% 
  group_by(x, y, year = year(time)) %>% 
  summarise(precipitation = mean(precipitation)) %>% 
  ggplot(aes(year, precipitation)) +
  geom_boxplot(aes(group = as.factor(year))) +
  geom_smooth(method = "lm") +
  theme_bw() +
  xlab("") + ylab("Temperature (째C)") +
  ggtitle("Capricho interannual variability")
```

```{r}
chirps %>% 
  filter(month(time) %in% c(1, 2, 12)) %>% 
  group_by(x, y, year = year(time)) %>% 
  summarise(precipitation = sum(precipitation)) %>% 
  ggplot(aes(year, precipitation)) +
  geom_boxplot(aes(group = as.factor(year))) +
  geom_smooth(method = "lm") +
  theme_bw() +
  xlab("") + ylab("Temperature (째C)") +
  ggtitle("Capricho dry-season interannual variability")
```

```{r}
chirps %>% 
  filter(!(month(time) %in% c(1, 2, 12))) %>% 
  group_by(x, y, year = year(time)) %>% 
  summarise(precipitation = sum(precipitation)) %>% 
  ggplot(aes(year, precipitation)) +
  geom_boxplot(aes(group = as.factor(year))) +
  geom_smooth(method = "lm") +
  theme_bw() +
  xlab("") + ylab("Temperature (째C)") +
  ggtitle("Capricho wet-season interannual variability")
```

```{r}
anom_r <- chirps %>% 
  group_by(x, y, year = year(time)) %>% 
  summarise(precipitation = mean(precipitation)) %>% 
  group_by(year) %>% 
  mutate(anomaly = precipitation - mean(precipitation)) %>% 
  group_by(x, y) %>% 
  summarise(anomaly = mean(anomaly)) %>% 
  rast()
crs(anom_r) <- crs(chirps_r)
pal <- colorNumeric(c("#0C2C84", "#FFFFCC", "red"), values(anom_r), na.color = "transparent")
leaflet() %>% 
  addTiles() %>%
  addRasterImage(anom_r, colors = pal, opacity = 0.6) %>% 
  addPolygons(data = capricho, fill = NA) %>% 
  addLegend(pal = pal, values = values(anom_r),
                  title = "Anomaly")
```
