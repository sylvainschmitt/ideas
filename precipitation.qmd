# Precipitation {.unnumbered}

```{r setup}
#| include: false
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(tidyverse)
library(terra)
library(sf)
library(bayesplot)
knitr::opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
  cache = T, cache.lazy = F)
```

## Capricho

We used CHIRPS data at 0.05-degree resolution with pentad (5-days) precipitation accumulation.

```{r}
data_r <- rast("results/data/chirps_indices_capricho.nc")
data <- data_r %>% 
  as.data.frame() %>% 
  gather(pentad, pr) %>% 
  group_by(pentad) %>% 
    summarise(l = quantile(pr, 0.025, na.rm = TRUE), 
            m = mean(pr, na.rm = TRUE), 
            h = quantile(pr, 0.975, na.rm = TRUE)) %>% 
  mutate(time = time(data_r))
```

### Pentad

```{r}
data %>% 
  ggplot(aes(time, m)) +
  geom_ribbon(aes(ymin = l, ymax = h), col = NA, alpha = 0.2) +
  geom_line() +
  geom_point() +
  theme_bw() +
  xlab("") + ylab("Precipitation (mm/5-days)") +
  ggtitle("Pentad (5 days) variations in Capricho")
```

```{r}
data %>% 
  mutate(year = year(time)) %>% 
  mutate(week = week(time)) %>% 
  ggplot(aes(week, m)) +
  geom_line(aes(group = year, col = year)) +
  theme_bw() +
  geom_smooth(col = "red") +
  scale_color_viridis_c() +
  xlab("") + ylab("Precipitation (mm/5-days)") +
  ggtitle("Pentad (5 days) variations in Capricho") +
  scale_x_continuous(breaks = c(1, 5, 9, 13, 18, 22, 26, 31, 35, 40, 44, 48),
                   labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D"))
```

### Biweek

```{r}
floor_biweek <- function(full) 
  as_date(paste0(year(full), "-", month(full), "-", ifelse(day(full) > 15, 15, 1)))
data %>% 
  group_by(time = floor_biweek(time)) %>% 
  summarise(pr = sum(m)) %>% 
  ggplot(aes(time, pr)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Precipitation (mm/.5-month)") +
  ggtitle("Biweekly variations in Capricho") 
```

```{r}
floor_biweek <- function(full) 
  as_date(paste0(year(full), "-", month(full), "-", ifelse(day(full) > 15, 15, 1)))
data %>% 
  group_by(time = floor_biweek(time)) %>% 
  summarise(pr = sum(m)) %>% 
  mutate(year = year(time)) %>% 
  mutate(week = week(time)) %>% 
  ggplot(aes(week, pr)) +
  geom_line(aes(group = year, col = year)) +
  theme_bw() +
  geom_smooth(col = "red") +
  xlab("") + ylab("Precipitation (mm/.5-month)") +
  ggtitle("Biweekly variations in Capricho") +
  scale_color_viridis_c() +
  scale_x_continuous(breaks = c(1, 5, 9, 13, 18, 22, 26, 31, 35, 40, 44, 48),
                   labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D"))
```

### Month

```{r}
data %>% 
  group_by(time = floor_date(time, "month")) %>% 
  summarise(pr = sum(m)) %>% 
  ggplot(aes(time, pr)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Precipitation (mm/month)") +
  ggtitle("Monthly variations in Capricho") 
```

```{r}
data %>% 
  group_by(time = floor_date(time, "month")) %>% 
  summarise(pr = sum(m)) %>% 
  mutate(year = year(time)) %>% 
  mutate(week = week(time)) %>% 
  ggplot(aes(week, pr)) +
  geom_line(aes(group = year, col = year)) +
  theme_bw() +
  geom_smooth(col = "red") +
  xlab("") + ylab("Precipitation (mm/month)") +
  ggtitle("Monthly variations in Capricho") +
  scale_color_viridis_c() +
  scale_x_continuous(breaks = c(1, 5, 9, 13, 18, 22, 26, 31, 35, 40, 44, 48),
                   labels = c("J", "F", "M", "A", "M", "J", "J", "A", "S", "O", "N", "D"))
```

### Year

```{r}
data %>% 
  group_by(time = floor_date(time, "year")) %>% 
  summarise(pr = sum(m)) %>% 
  ggplot(aes(time, pr)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Precipitation (mm/year)") +
  ggtitle("Yearly variations in Capricho") +
  geom_smooth(col = "red")
```

```{r}
data %>% 
  group_by(time = floor_date(time, "month")) %>% 
  summarise(pr = sum(m)) %>% 
  group_by(time = floor_date(time, "year")) %>% 
  summarise(delta_pr = quantile(pr, 0.95) - quantile(pr, 0.05)) %>% 
  ggplot(aes(time, delta_pr)) +
  geom_line() +
  theme_bw() +
  xlab("") + ylab("Yearly variations of monthly precipitation (mm/year)") +
  ggtitle("Yearly variability in Capricho") +
  geom_smooth(col = "red")
```

## Colombian Amazon

We used CHIRPS data downscaled at 0.01-degree resolution with pentad (5-days) precipitation accumulation. Yearly precipitation changes were then calculated by computing the monthly means over two periods at the end (2020 to 2022) and start (2000 to 2002) of the study period. Using 3-y averages reduces the influences of climate variability.

```{r data}
#| include: false
pr_ind <- rast("results/data/chirps_indices_amazon.nc")
pr <- rast("results/data/chirps_anomalies_amazon.nc")
deforest <- rast("results/data/tmf_deforested_2022_2000_amzaonia.tif")
data <- lapply(deforest, as.data.frame, xy = T) %>% 
  bind_rows() %>% 
  left_join(as.data.frame(pr, xy = TRUE)) %>% 
  na.omit() %>% 
  mutate(intact = 1)
```

```{r ca2022}
ggplot() +
  tidyterra::geom_spatraster(data = pr_ind[[22]]) +
  theme_bw() +
  scale_fill_viridis_c("mm", na.value = NA) +
  ggtitle("Precipitaiton 2022")
```

```{r caanom}
ggplot() +
  tidyterra::geom_spatraster(data = pr) +
  theme_bw() +
  scale_fill_viridis_c("Â°C", na.value = NA) +
  ggtitle("Precipitation anomalies", "2000:2002 vs 2020:2022")
```

### Comparisons

Comparing deforestation surfaces to climate anomalies seems to indicate a decrease in precipitation with increasing deforestation surfaces. But caution should be taken because of possible spatial proximity between deforested pixels that could confound with the spatial structure of climate anomalies.

```{r cacomp}
data %>% 
  mutate(deforest = cut(deforest, breaks = seq(0, 1.3, by = 0.1),
                              labels = seq(0, 1.2, by = 0.1)+0.05)) %>% 
  ggplot(aes(deforest, precipitation)) +
  geom_boxplot() +
  theme_bw() +
  geom_smooth(aes(x = as.numeric(deforest))) +
  xlab("Deforestation surface (km2, 2000-2022)") +
  ylab("Yearly anomalies of precipitation")
```

### Linear regressions

Classic linear regression without accounting for spatial autocorrelation found a general and significant decrease in precipitation (-240mm/year) and a significant decrease in precipitation (-81mm/year) with deforestation. However, inspecting models residuals revealed a significant spatial autocorrelation of model errors up to several hundred of kilometres questioning the robustness of the results.

```{r calm}
reg <- lm(precipitation ~ 0 + intact + deforest, data)
sjPlot::tab_model(reg)
```

```{r calmcor}
data2 <- data
data2$res <- residuals(reg) 
data2 <- data2 %>% sample_n(1000)
cor <- pgirmess::correlog(data.frame(data2$x, data2$y), data2$res,
                   method = "Moran", nbclass = 30) %>% 
    as.data.frame()
cor %>% 
  ggplot(aes(x = dist.class*100, y = coef)) + 
  geom_point(aes(alpha = p.value < 0.01)) + geom_line() +
  geom_hline(yintercept = 0) +
  theme_bw() +
  xlab("Distance (km)") + ylab("Moran\'s I") +
  scale_x_log10() +
  ylim(-1, 1) +
  ggtitle("Residuals spatial auto-correlation")
```

### Spatial regressions

To account for spatial autocorrelation, we took advantage of a method including spatial autocorrelation in model error (spNNGP, Gaussian univariate Bayesian spatial regression models using Nearest Neighbor Gaussian Processes, see note below). We found only a small significant effect of deforestation on precipitation decrease accounting for spatial autocorrelation (-3mm/year).

```{r srca}
#| eval: false
library(spNNGP)
sr <- spNNGP(formula = precipitation ~ 0 + intact + deforest,
                data = data,
                coords = data[c("x", "y")], 
                starting = list("phi" = 3 / 0.5, "sigma.sq" = 1, "tau.sq" = 1),
                tuning = list("phi" = 0.2), 
                priors = list("phi.Unif" = c(3 / 1, 3 / 0.1), 
                              "sigma.sq.IG" = c(2, 1), "tau.sq.IG" = c(2, 1)), 
                cov.model = "exponential",
                n.samples = 2000, 
                n.neighbors = 10, method = "latent", 
                n.omp.threads = 20, n.report = 1000, fit.rep = TRUE,
                sub.sample = list(start = 1000), return.neighbor.info = TRUE)
save(sr, file = "save/pr.Rdata")
```

```{r srcaload}
load("save/pr.Rdata")
```

```{r srcatrace}
mcmc_trace(sr$p.beta.samples, n_warmup = 1000) 
```

```{r srcapost}
mcmc_hist(sr$p.beta.samples[1001:2000,])
```
